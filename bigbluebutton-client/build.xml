<?xml version="1.0" encoding="utf-8"?>
<!-- BigBlueButton Client build.xml for use by Hudson builds. -->
<project name="BigBlueButton Client" basedir="." default="cleanandmake" >
    <property environment="env" />
    <property name="FLEX_HOME" value="${env.FLEX_HOME}" />
	<property name="APP_ROOT" value="./src" />
	<property name="ROOT_DIR" value="." />
	<property name="OUTPUT_DIR" value="./bin" />
	<taskdef resource="flexTasks.tasks" classpath="${FLEX_HOME}/ant/lib/flexTasks.jar" />
	
	<target name="mxmlc-component" depends="copy-config-xml" description="Compiling the BBB mxml files">
		<mxmlc-compile target="${APP_ROOT}/BigBlueButton" />
		<mxmlc-compile target="${APP_ROOT}/ChatModule" />
		<mxmlc-compile target="${APP_ROOT}/ViewersModule" />
		<mxmlc-compile target="${APP_ROOT}/ListenersModule" />
		<mxmlc-compile target="${APP_ROOT}/PresentModule" />
		<mxmlc-compile target="${APP_ROOT}/DeskShareModule" />		
		<mxmlc-compile target="${APP_ROOT}/PhoneModule" />
		<mxmlc-compile target="${APP_ROOT}/AutotestModule" />
		<mxmlc-compile target="${APP_ROOT}/VideoconfModule" />
		
<!-- REMOVE FOR NOW (RALAM AUG 3, 2009)
		<mxmlc-compile target="${APP_ROOT}/LoginModule" />
		<mxmlc-compile target="${APP_ROOT}/NotesModule" />
		<mxmlc-compile target="${APP_ROOT}/HighlighterModule" />
-->
		
		<copy todir="${OUTPUT_DIR}/conf" >
			<fileset dir="./src/conf" />
		</copy>

		<copy todir="${OUTPUT_DIR}/swfobject/" >
			<fileset dir="./src/swfobject/" />
		</copy>
		
		<copy todir="${OUTPUT_DIR}/org/bigbluebutton/common/assets/images" >
			<fileset dir="./src/org/bigbluebutton/common/assets/images/" />
		</copy>
<!--
		<copy todir="${OUTPUT_DIR}/org/bigbluebutton/main/view/assets/images" >
			<fileset dir="./src/org/bigbluebutton/main/view/assets/images" />
		</copy>
-->
		<copy todir="${OUTPUT_DIR}/org/bigbluebutton/modules/listeners/view/assets/images/" >
			<fileset dir="./src/org/bigbluebutton/modules/listeners/view/assets/images/" />
		</copy>

		<copy todir="${OUTPUT_DIR}/org/bigbluebutton/modules/phone/views/assets/images/" >
			<fileset dir="./src/org/bigbluebutton/modules/phone/views/assets/images/" />
		</copy>
		
		<copy todir="${OUTPUT_DIR}/org/bigbluebutton/modules/videoconf/views/assets/images/" >
			<fileset dir="./src/org/bigbluebutton/modules/videoconf/views/assets/images/" />
		</copy>
		
		<copy file="./html-template/bbb-deskshare-applet-0.62.jar" todir="${OUTPUT_DIR}"/>
		
		<move todir="${OUTPUT_DIR}" >
			<fileset dir="${OUTPUT_DIR}/src" />
		</move>
	</target>

	<target name="check-config-xml">
    		<available file="/var/www/bigbluebutton/client/conf/config.xml" property="config-xml.present"/>
	</target>

	<target name="copy-config-xml" depends="check-config-xml" if="config-xml.present">
		<echo message="Updating config.xml from /var/www/bigbluebutton/client/conf/config.xml" />
		<copy file="/var/www/bigbluebutton/client/conf/config.xml" todir="${OUTPUT_DIR}/conf" /> 
	</target>
	
	<target name="generate-wrapper" depends="mxmlc-component, localization">
		<html-wrapper
			title="BigBlueButton"
			file="BigBlueButton.html"
			height="100%"
			width="100%"
			bgcolor="grey"
			application="BBB"
			swf="BigBlueButton"
			version-major="9"
			version-minor="0"
			version-revision="0"
			history="true"
			template="express-installation"
			output="${OUTPUT_DIR}"
		/>
		<copy file="./html-template/BigBlueButton.html" todir="${OUTPUT_DIR}" overwrite="true"/>
	</target>

	<target name="clean">
		<delete dir="${OUTPUT_DIR}" />
	</target>

	<target name="cleanandmake" depends="clean, generate-wrapper"></target>
	
	<macrodef name="mxmlc-compile">
		<attribute name="target" description="Path to the file being compiled." />
		<attribute name="flex" default="${env.FLEX_HOME}" description="Location of the Flex install." />
		<attribute name="app" default="."/>
		<attribute name="output" default="./output" description="" />
		<sequential>
			<mxmlc 
				file="@{target}.mxml" 
				output="${OUTPUT_DIR}/@{target}.swf" 
				debug="false"
			>
				<load-config filename="@{flex}/frameworks/flex-config.xml" />
				<source-path path-element="@{flex}/frameworks" />
				<compiler.library-path dir="@{flex}/frameworks" append="true">
					<include name="libs" />
					<include name="../bundles/{locale}" />
				</compiler.library-path>

				<compiler.library-path dir="@{app}" append="true">
					<include name="libs" />
					<include name="libs/generated" />
				</compiler.library-path>

				<default-size width="500" height="600" />
			</mxmlc>
		</sequential>
	</macrodef>
	
	<target name="localization" description="Builds BigBlueButton localization files">
		<echo>Building Localization .swf's</echo>
		<compileLocale locale="en_US" />
		<compileLocale locale="zh_CN" />
		<compileLocale locale="fr_FR" />
	</target>
	
	<!-- Compiles Localization Resource Bundle. -->
	<macrodef name="compileLocale" description="Compiles the Resource package for the given locale">
		<attribute name="locale" default="en_US"/>
		<sequential>
			<!--
			Create the Flex Home directory for the language in question.
			This is necessary to compensate for a bug in pre-3.2 releases of 
			mxmlc.
			
			<mkdir dir="${FLEX_HOME}/frameworks/locale/@{locale}"/>-->
			
			<!-- Invoke MXMLC -->
			<mxmlc output="${OUTPUT_DIR}/locale/@{locale}_resources.swf">
				<locale>@{locale}</locale>
				<source-path path-element="locale/{locale}"/>
				<include-resource-bundles>bbbResources</include-resource-bundles>
				<source-path path-element="${FLEX_HOME}/frameworks"/>
			</mxmlc>
		</sequential>
	</macrodef>
</project>
